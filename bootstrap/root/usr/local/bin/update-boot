#!/usr/bin/env bash
set -Eeo pipefail; shopt -s inherit_errexit

main() {
  [[ $# -eq 0 ]] || usage
  local meta_json_new http_code
  if ! meta_json_new=$(curl_img_reg "${VARIANT:?}/meta.json" -w '%{http_code}'); then
    printf "update-boot: Unable to retrieve image metadata from image-registry\n" >&2
    return 1
  fi
  http_code=$(tail -n1 <<<"$meta_json_new")
  if [[ $http_code = 404 ]]; then
    printf "update-boot: No image has been built for the variant '%s' yet\n" "$VARIANT" >&2
    return 0
  fi
  if [[ $http_code != 200 ]]; then
    printf "update-boot: Unable to retrieve image metadata from image-registry (HTTP response code %s)\n" "$http_code" >&2
    return 1
  fi
  meta_json_new=$(head -n-1 <<<"$meta_json_new")
  local current_rootimg_sha256 try_rootimg_sha256 new_rootimg_sha256
  current_rootimg_sha256=$(compgen -G /run/initramfs/root.*.img | cut -d. -f2)
  try_rootimg_sha256=$(cat /boot/phxc/try.sha256 2>/dev/null || true)
  new_rootimg_sha256=$(jq -re '.sha256sums["root.img"]' <<<"$meta_json_new")
  if [[ $current_rootimg_sha256 = "$new_rootimg_sha256" ]]; then
    printf "update-boot: boot partition is up-to-date (image is currently running)\n" >&2
    return 0
  fi
  if [[ $try_rootimg_sha256 = "$new_rootimg_sha256" ]]; then
    if [[ -e /run/initramfs/try-reboot ]]; then
      printf "update-boot: boot partition is up-to-date (newer image will be tried)\n" >&2
    else
      printf "update-boot: boot partition is up-to-date (newer image failed to boot)\n" >&2
    fi
    return 0
  fi
  printf "update-boot: boot partition is outdated, updating now\n" >&2
  rm -f /boot/phxc/try.sha256 /boot/phxc/root.try.img /boot/EFI/Linux/uki.try.efi /boot/tryboot.img /run/initramfs/try-reboot
  # shellcheck disable=SC2064
  trap "rm -f /run/initramfs/try-reboot /boot/phxc/try.sha256 /boot/phxc/root.try.img /boot/EFI/Linux/uki.try.efi /boot/tryboot.img /run/initramfs/try-reboot" EXIT
  printf "%s" "$new_rootimg_sha256" >/boot/phxc/try.sha256
  curl_img_reg "$VARIANT/root.img" -o"/boot/phxc/root.${new_rootimg_sha256}.img" -f
  if [[ $VARIANT = rpi* ]]; then
    curl_img_reg "$VARIANT/boot.img" -o/boot/tryboot.img -f
  else
    curl_img_reg "$VARIANT/uki.efi" -o/boot/EFI/Linux/uki.try.efi -f
  fi
  printf "update-boot: boot partition has been updated\n" >&2
  trap '' EXIT
  systemctl start --no-block try-reboot
}

curl_img_reg() {
  local path=$1
  shift
  curl --cacert /usr/local/share/ca-certificates/phxc-root.crt \
    -L --no-progress-meter --connect-timeout 5 \
    --retry 10 --retry-delay 60 \
    "https://image-registry.phxc.svc.cluster.local:8020/$path" "$@"
}

usage() {
  printf "Usage: update-boot\n" >&2
  return 1
}

main "$@"
