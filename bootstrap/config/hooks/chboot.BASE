#!/usr/bin/env bash

error=0; trap 'error=$(($?>$error?$?:$error))' ERR # save maximum error code

skiptask chboot

# shellcheck source=../../lib/disk_var.sh
source "$LOGDIR/disk_var.sh"
# Running here to run *after* "finish" task
if devpath=$(losetup --show --find --partscan "${IMAGE_PATH:?}"); then
  zerofree "${BOOT_PARTITION}"
  losetup --detach "$devpath"
fi

exit $error
