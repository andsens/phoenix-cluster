#!/usr/bin/env bash

error=0; trap 'error=$(($?>$error?$?:$error))' ERR # save maximum error code

[[ -z $HOME_CLUSTER_GIT_REMOTE_SSH_KEYS ]] || \
  printf "%s\n" "$HOME_CLUSTER_GIT_REMOTE_SSH_KEYS" >> "${target:?}/root/.ssh/known_hosts"

fcopy -Sm root,root,0700 /usr/local/sbin/bootstrap-vms

for unit in bootstrap-vms.service var-lib-bootstrapper.mount; do
  fcopy -SM "/etc/systemd/system/$unit"
  $ROOTCMD systemctl enable "$unit"
done

$ROOTCMD fai-mk-configspace

exit $error
