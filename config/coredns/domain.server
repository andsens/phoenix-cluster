${DOMAIN}:53 ${DOMAIN}:5353 {
    view external-ipv4 {
        expr type() == 'A' && ! incidr(client_ip(), '0.0.0.0/8') && ! incidr(client_ip(), '10.0.0.0/8') && ! incidr(client_ip(), '100.64.0.0/10') && ! incidr(client_ip(), '127.0.0.0/8') && ! incidr(client_ip(), '169.254.0.0/16') && ! incidr(client_ip(), '172.16.0.0/12') && ! incidr(client_ip(), '192.0.0.0/24') && ! incidr(client_ip(), '192.0.2.0/24') && ! incidr(client_ip(), '192.88.99.0/24') && ! incidr(client_ip(), '192.168.0.0/16') && ! incidr(client_ip(), '198.18.0.0/15') && ! incidr(client_ip(), '198.51.100.0/24') && ! incidr(client_ip(), '203.0.113.0/24') && ! incidr(client_ip(), '224.0.0.0/4') && ! incidr(client_ip(), '240.0.0.0/4') && ! incidr(client_ip(), '255.255.255.255/32')
    }
    template IN A . {
        answer "{{.Name}} 60 IN A ${WAN_IPV4}"
    }
}
${DOMAIN}:53 ${DOMAIN}:5353 {
    errors
    health
    ready
    forward . /etc/resolv.conf
    cache 30
    loop
    reload
    loadbalance
    template IN NS ${DOMAIN}. {
        answer "${DOMAIN}. 0 IN NS ns1.${DOMAIN}"
    }
    template IN A api.${DOMAIN}. {
        answer "api.${DOMAIN}. 60 IN A ${K8SMASTER_IPV4}"
    }
    template IN AAAA api.${DOMAIN}. {
        answer "api.${DOMAIN}. 60 IN AAAA ${K8SMASTER_IPV6}"
    }
    template IN CAA ${DOMAIN}. {
        answer "${DOMAIN}. 0 IN CAA 0 issue \"letsencrypt.org;\""
    }
    etcd {
        stubzones
        path /skydns
        endpoint http://${ETCD_IPV4}:2379
    }
}
