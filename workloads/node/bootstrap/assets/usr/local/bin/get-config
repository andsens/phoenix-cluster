#!/usr/bin/env bash
set -Eeo pipefail; shopt -s inherit_errexit
PKGROOT=$(dirname "$(realpath "${BASH_SOURCE[0]}")")
# shellcheck disable=SC1091
source "$PKGROOT/../lib/phoenix-cluster/node.sh"

main() {
  local e; for e; do [[ "$e" != "--help" ]] || usage; done
  [[ -n $1 && -n $2 && $# -ge 2 && $# -le 4 ]] || usage
  local quiet=false
  if [[ $1 = '-q' ]]; then quiet=true; shift; fi
  local filepath=$1 key=$2 default=$3
  if [[ -e $filepath ]] && yq -r 'paths | join(".")' "$filepath" | grep -q "^$key$"; then
    key=$(escape_key "$key")
    yq -r ".$key" "$filepath"
  elif [[ -n $default ]]; then
    printf "%s\n" "$default"
  else
    $quiet || printf "%s is not set in '%s'\n" "$key" "$filepath" >&2
    return 1
  fi
}

escape_key() {
  # Converts any path like some-path.to-something.here
  # into ["some-path"]["to-something"]["here"]
  # This means dots in keys are not allowed
  local key=$1
  key=${key//'.'/'"]["'}
  key="[\"$key\"]"
  printf "%s\n" "$key"
}

usage() {
  printf "Usage: get-config [-q] FILEPATH KEY DEFAULT\n" >&2
  return 1
}

main "$@"
