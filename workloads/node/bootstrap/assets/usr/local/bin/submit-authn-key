#!/usr/bin/env bash
set -Eeo pipefail; shopt -s inherit_errexit

main() {
  [[ $# -eq 0 ]] || usage
  local authn_pubkey result retry=15
  authn_pubkey=$(step crypto jwk public </run/initramfs/authn-key.json)
  while true; do
    if result=$(curl-boot-server authn-key -H 'Content-Type: application/json' \
      -XPUT -d@<(printf "%s" "$authn_pubkey") -w '%{http_code}' | tail -n1); then
      return 0
    else
      if [[ $result = 403 ]]; then
        printf "Authentication key submission failed, a different authn key has already been submitted\n" >&2
        return 1
      else
        printf "Failed to submit authentication key (HTTP code: %s), retrying in %ds\n" "$result" "$retry" >&2
      fi
    fi
    sleep $retry
  done
}

usage() {
  printf "Usage: submit-authn-key\n" >&2
  return 1
}

main "$@"
