#!/usr/bin/env bash
set -Eeo pipefail; shopt -s inherit_errexit

main() {
  [[ $# -eq 0 ]] || usage
  local authn_pubkey jwt result
  authn_pubkey=$(step crypto jwk public </run/initramfs/authn-key.json)
  jwt=$(sign-jwt authn-key)
  if result=$(curl-boot-server "authn-key?jwt=$jwt" \
    -XPUT -d@<(printf "%s" "$authn_pubkey") -w '%{http_code}' | tail -n1); then
    return 0
  else
    if [[ $result = 403 ]]; then
      printf "Authentication key submission failed, a different authn key has already been submitted\n" >&2
      return 1
    else
      printf "Failed to submit authentication key (HTTP code: %s)\n" "$result" >&2
      return 1
    fi
  fi
}

usage() {
  printf "Usage: submit-authn-key\n" >&2
  return 1
}

main "$@"
