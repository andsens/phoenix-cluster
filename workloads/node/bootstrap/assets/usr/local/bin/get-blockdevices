#!/usr/bin/env bash
set -Eeo pipefail; shopt -s inherit_errexit

main() {
  local blockdevices='[]' devpath disk_filesystem disk_partitions
  for devpath in $(lsblk --json --output NAME,FSTYPE,TYPE,MAJ:MIN | jq -r '.blockdevices[] | select(.type=="disk" and .pkname==null) | "/dev/\(.name)"'); do
    disk_filesystem=$(lsblk -Jndo FSTYPE "$devpath" | jq '.blockdevices[0].fstype')
    disk_partitions=$(sfdisk -J "$devpath" 2>/dev/null || printf "null")
    blockdevices=$(jq \
      --arg devpath "$devpath" \
      --argjson fs "$disk_filesystem" \
      --argjson part "$disk_partitions" \
      '. + [{"devpath": $devpath, "filesystem": $fs, "partitions": $part}]' \
      <<<"$blockdevices"
    )
  done
  printf "%s\n" "$blockdevices"
}

main "$@"
