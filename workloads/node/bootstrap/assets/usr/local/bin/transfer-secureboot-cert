#!/usr/bin/env bash
set -Eeo pipefail; shopt -s inherit_errexit

main() {
  local e; for e; do [[ "$e" != "--help" ]] || usage; done
  [[ $# -eq 1 ]] || usage
  if [[ $1 = check ]]; then
    check
  elif [[ $1 = transfer ]]; then
    transfer
  else
    usage
  fi
}

check() {
  local jwt result
  if kubectl -n node get secret secureboot &>/dev/null; then
    printf "The secureboot secret already exists\n" >&2
    return 1
  fi
  jwt=$(sign-jwt transfer-enabled)
  if result=$(curl-boot-server "transfer-enabled?jwt=$jwt" \
    -XGET -w '%{http_code}' | tail -n1); then
    return 0
  else
    if [[ $result = 503 ]]; then
      printf "The smallstep secret transfer feature is not enabled on the boot-server\n" >&2
      return 1
    else
      printf "The boot-server returned an unexpected response: %s\n" "$result" >&2
      return 1
    fi
  fi
}

transfer() {
  local jwt secureboot_cert secureboot_key
  jwt=$(sign-jwt secureboot-cert)
  secureboot_cert=$(curl-boot-server "secureboot-cert?jwt=$jwt")
  jwt=$(sign-jwt secureboot-key)
  secureboot_key=$(curl-boot-server "secureboot-key?jwt=$jwt")
  kubectl create -n node secret tls secureboot --cert=<(printf "%s\n" "$secureboot_cert") --key=<(printf "%s\n" "$secureboot_key")
}

usage() {
  printf "Usage: transfer-root-key (check|transfer)\n" >&2
  return 1
}

main "$@"
