#!/usr/bin/env bash
set -Eeo pipefail; shopt -s inherit_errexit

main() {
  [[ $# -eq 0 ]] || usage
  local network
  for network in $(jq -r '(.networks // {}) | keys[]' /run/initramfs/node-config.json); do
    local mac
    mac=$(jq -r --arg network "$network" '.networks[$network].mac' /run/initramfs/node-config.json)
    if jq -re --arg network "$network" '.networks[$network].dhcp' /run/initramfs/node-config.json &>/dev/null; then
      cat <<EOF >"/etc/systemd/network/$network.network"
[Match]
MACAddress=$mac
[Network]
DHCP=yes
EOF
    else
      local addrs
      addrs=$(jq -r --arg network "$network" '.networks[$network].static[] | "Address=\(.)"' /run/initramfs/node-config.json)
      cat <<EOF >"/etc/systemd/network/$network.network"
[Match]
MACAddress=$mac
[Network]
$addrs
EOF
    fi
  done
}

usage() {
  printf "Usage: configure-networks\n" >&2
  return 1
}

main "$@"
