#!/usr/bin/env bash
set -Eeo pipefail; shopt -s inherit_errexit

main() {
  local e; for e; do [[ "$e" != "--help" ]] || usage; done
  [[ $# -eq 1 ]] || usage
  if [[ $1 = check ]]; then
    check
  elif [[ $1 = init ]]; then
    init
  else
    usage
  fi
}

check() {
  if kubectl -n node get configmap node-authn-keys &>/dev/null; then
    printf "The node-authn-keys get configmap already exists\n" >&2
    return 1
  fi
}

init() {
  local primary_mac filename
  primary_mac=$(get-node-state primary-mac)
  filename=${primary_mac//:/-}.json
  kubectl create -n node configmap node-states --from-file="$filename"=/run/initramfs/node-state.json
  kubectl create -n node secret generic node-configs --from-file="$filename"=/run/initramfs/node-config.json
  kubectl create -n node configmap node-authn-keys --from-file="$filename"=/run/initramfs/authn-key.json
}

usage() {
  printf "Usage: initialize-registry (check|init)\n" >&2
  return 1
}

main "$@"
