#!/usr/bin/env bash
set -Eeo pipefail; shopt -s inherit_errexit

main() {
  local e; for e; do [[ "$e" != "--help" ]] || usage; done
  [[ -n $1 && $# -eq 1 ]] || usage
  local purpose=$1 machine_id
  machine_id=$(cat /etc/machine-id)
  step crypto jwt sign --key /run/initramfs/authn-key.json --iss "$machine_id" --jti '' \
    --aud boot-server --sub "$purpose" --nbf "$(date -d'-30sec' +%s)" --exp "$(date -d'+30sec' +%s)"
}

usage() {
  printf "Usage: sign-jwt PURPOSE\n" >&2
  return 1
}

main "$@"
