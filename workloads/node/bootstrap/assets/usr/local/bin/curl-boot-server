#!/usr/bin/env bash
set -Eeo pipefail; shopt -s inherit_errexit

main() {
  local e; for e; do [[ "$e" != "--help" ]] || usage; done
  [[ $# -ne 0 ]] || usage
  local boot_server_ip machine_id method=GET jwt_token url_path=$1
  shift
  boot_server_ip=$(get-node-state boot-server)
  machine_id=$(cat /etc/machine-id)
  for e; do
    case $e in
      -XGET|-XPOST|-XPUT|-XDELETE|-XPATCH) method=${e#'-X'} ;;
    esac
  done
  jwt_token=$(step crypto jwt sign --key /run/initramfs/authn-key.json --iss "$machine_id" --jti '' \
    --aud boot-server --sub "$method $url_path" --nbf "$(date -d'-30sec' +%s)" --exp "$(date -d'+30sec' +%s)")
  curl --cacert /usr/local/share/ca-certificates/home-cluster-root.crt \
    -H "Authorization: Bearer $jwt_token" \
    --connect-to "boot-server.node.svc.cluster.local:8020:$boot_server_ip:8020" \
    -fL --no-progress-meter --connect-timeout 5 \
    "https://boot-server.node.svc.cluster.local:8020/$url_path" "$@"
}

usage() {
  printf "Usage: curl-boot-server PATH <CURL-ARGS>...\n" >&2
  return 1
}

main "$@"
