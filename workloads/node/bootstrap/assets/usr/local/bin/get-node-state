#!/usr/bin/env bash
set -Eeo pipefail; shopt -s inherit_errexit
PKGROOT=$(dirname "$(realpath "${BASH_SOURCE[0]}")")
source "$PKGROOT/../lib/home-cluster/node.sh"

main() {
  [[ -n $1 ]] || { printf "Usage: get-node-state KEY\n" >&2; return 1; }
  local key=$1
  if jq -r 'paths | join(".")' /run/initramfs/node-state.json | grep -q "^$key$"; then
    key=$(escape_key "$key")
    flock -s /run/initramfs/node-state.json jq -r ".$key" /run/initramfs/node-state.json
  else
    printf "%s is not set in node-state.json" "$key" >&2
    return 1
  fi
}

main "$@"
