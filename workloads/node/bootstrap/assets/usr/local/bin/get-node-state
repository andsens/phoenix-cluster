#!/usr/bin/env bash
set -Eeo pipefail; shopt -s inherit_errexit
PKGROOT=$(dirname "$(realpath "${BASH_SOURCE[0]}")")
source "$PKGROOT/../lib/home-cluster/node.sh"

main() {
  [[ -n $1 ]] || { printf "Usage: get-node-state\n" >&2; return 1; }
  local key=$1
  if jq -r 'paths | join(".")' "$NODE_STATE_PATH" | grep -q "^$key$"; then
    key=$(escape_key "$key")
    # shellcheck disable=SC2016
    flock -s "$NODE_STATE_PATH" jq -r ".$key" "$NODE_STATE_PATH"
  else
    printf "%s is not set in node-state.json" "$key" >&2
    return 1
  fi
}

main "$@"
