#!/usr/bin/env bash
set -Eeo pipefail; shopt -s inherit_errexit
PKGROOT=$(dirname "$(realpath "${BASH_SOURCE[0]}")")
source "$PKGROOT/../lib/home-cluster/node.sh"

main() {
  [[ -n $1 ]] || { printf "Usage: is-node-state KEY [JSONVALUE]\n" >&2; return 1; }
  local key=$1 value=true state
  [[ -z $2 ]] || value=$2
  if jq -r 'paths | join(".")' /run/initramfs/node-state.json | grep -q "^$key$"; then
    key=$(escape_key "$key")
    state=$(flock -s /run/initramfs/node-state.json jq ".$key" /run/initramfs/node-state.json)
    if [[ $state = "$value" ]]; then
      return 0
    else
      return 1
    fi
  else
    printf "%s is not set in node-state.json" "$key" >&2
    return 1
  fi
}

main "$@"
