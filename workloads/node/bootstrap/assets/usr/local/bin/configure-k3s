#!/usr/bin/env bash
set -Eeo pipefail; shopt -s inherit_errexit

main() {
  mkdir -p /etc/rancher/k3s/config.yaml.d

  local label label_config="node-label: []" k3s_type=agent
  for label in $(jq -r '(.["node-label"] // [])[]' /run/initramfs/node-config.json); do
    if [[ $label = 'node-role.kubernetes.io/control-plane=true' ]]; then
      k3s_type=server
      # Filter out the label, it's not a valid label we can set
      continue
    fi
    # shellcheck disable=SC2016
    label_config=$(yq -y --arg l "$label" '.["node-label"]+=[$l]' <<<"$label_config")
  done
  printf '%s\n' "$label_config" >/etc/rancher/k3s/config.yaml.d/node-label.yaml

  if [[ -e /run/initramfs/cluster-secrets.json ]]; then
    # shellcheck disable=SC2016
    (umask 0077; yq -y '{token: .["k3s-token"]}' /run/initramfs/cluster-secrets.json >/etc/rancher/k3s/config.yaml.d/token.yaml)
    yq -y '{server: (.["control-plane-addrs"] | first)}' /run/initramfs/cluster-secrets.json >/etc/rancher/k3s/config.yaml.d/server.yaml
  fi
  ln -sf "$k3s_type.yaml" /etc/rancher/k3s/config.yaml
}

main "$@"
