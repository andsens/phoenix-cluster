#!/usr/bin/env bash
set -Eeo pipefail; shopt -s inherit_errexit

main() {
  local diff current new
  current=$(jq -c --sort-keys 'del(.disk.force)' /run/initramfs/node-config.json)
  new=$(download-node-config | jq -c --sort-keys 'del(.disk.force)')
  if [[ ! -e /run/initramfs/node-config.json ]] || ! diff=$(diff -u <(printf "%s" "$current") <(printf "%s" "$new") 2>/dev/null); then
    printf "New node-config received, caching to %s and then rebooting in 10s.\nDiff is:\n%s\n" /boot/home-cluster/node-config.json.enc "$diff" >&2
    systemd-creds encrypt /run/initramfs/node-config.json /boot/home-cluster/node-config.json.enc
    systemd-run --on-active=10 --timer-property=AccuracySec=100ms systemctl reboot
  fi
}

main "$@"
