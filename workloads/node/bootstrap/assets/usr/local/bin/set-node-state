#!/usr/bin/env bash
set -Eeo pipefail; shopt -s inherit_errexit
PKGROOT=$(dirname "$(realpath "${BASH_SOURCE[0]}")")
source "$PKGROOT/../lib/home-cluster/node.sh"

main() {
  local e; for e; do [[ "$e" != "--help" ]] || usage; done
  [[ -n $1 && -n $2 && $# -le 3 ]] || usage
  local key=$1 val=$2 val_is_json=${3:-false} val_arg
  if $val_is_json; then
    val_arg=--argjson
    printf 'Setting node-state key "%s" to JSON value "%s"\n' "$key" "$val" >&2
  else
    val_arg=--arg
    printf 'Setting node-state key "%s" to "%s"\n' "$key" "$val" >&2
  fi
  key=$(escape_key "$key")
  # shellcheck disable=SC2016,SC2097,SC2098
  key=$key val=$val val_arg=$val_arg flock -x /run/initramfs/node-state.json bash <<'EOR'
new_node_state=$(jq -re $val_arg val "$val" ".$key=\$val" /run/initramfs/node-state.json)
printf "%s\n" "$new_node_state" > /run/initramfs/node-state.json
EOR
}

usage() {
  printf "Usage: set-node-state KEY VAL [<val-is-json>]\n" >&2
  return 1
}

main "$@"
