#!/usr/bin/env bash
set -Eeo pipefail; shopt -s inherit_errexit
PKGROOT=/usr/local/lib/upkg/.upkg/home-cluster

main() {
  local image images
  # shellcheck disable=SC2016
  readarray -d $'\n' -t images < <(
    (
      LOGLEVEL=warning "$PKGROOT/bin/manifest" build all | \
        yq -r '. as $root | paths | select(. | join(".") | endswith(".image")) as $image |
        $root | getpath($image) | select(type == "string" and (startswith("cluster.local/") | not))'
      find "$PKGROOT/workloads" -name Dockerfile -exec grep FROM \{\} \; | cut -d ' ' -f 2
    ) | sort -u
  )
  for image in "${images[@]}"; do
    printf "Pulling %s\n" "$image" >&2
    ctr -n k8s.io image pull --snapshotter stargz "$image"
  done
}

main "$@"
