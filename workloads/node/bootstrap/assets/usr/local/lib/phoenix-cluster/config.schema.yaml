---
$schema: http://json-schema.org/draft-07/schema#
type: object
properties:
  $schema:
    type: string
  cluster:
    anyOf:
    - type: object
      properties:
        k3s-token:
          type: string
        k3s-url:
          type: string
          format: uri
      required: [token, url]
      additionalProperties: false
    - type: object
      properties:
        domain:
          description: The domain of the cluster
          type: string
          format: hostname
        admin:
          type: object
          description: Configuration of the "admin" user
          properties:
            ssh-key:
              description: The SSH key to add to /home/admin/.ssh/authorized_keys
              type: string
            pwhash:
              description: sudo password for the admin (ssh password authentication is disabled)
              type: string
          required: [ssh-key, pwhash]
          additionalProperties: false
        cluster-cidrs:
          type: object
          description: CIDRs specifying the subnets the cluster should allocate for pods, services and loadbalancers
          properties:
            podIPv4:
              $ref: "#/definitions/ipv4-cidr"
            podIPv6:
              $ref: "#/definitions/ipv6-cidr"
            svcIPv4:
              $ref: "#/definitions/ipv4-cidr"
            svcIPv6:
              $ref: "#/definitions/ipv6-cidr"
            lbIPv4:
              $ref: "#/definitions/ipv4-cidr"
            lbIPv6:
              $ref: "#/definitions/ipv6-cidr"
          required: [podIPv4, podIPv6, svcIPv4, svcIPv6, lbIPv4, lbIPv6]
          additionalProperties: false
      required: [domain, admin, cluster-cidrs]
      additionalProperties: false
  disk-encryption:
    anyOf:
    - type: object
      properties:
        method:
          type: string
          enum: [tpm, insecure-online, insecure-offline]
      required: [method]
      additionalProperties: false
    - type: object
      properties:
        method:
          const: rpi-otp
        range:
          type: object
          properties:
            from:
              type: integer
            to:
              type: integer
        initialize:
          type: boolean
        key-derivation-suffix:
          type: string
      required: [method, range, initialize, key-derivation-suffix]
      additionalProperties: false
  hostname:
    type: string
    format: hostname
  network:
    patternProperties:
      "([0-9a-f]{2}:){5}[0-9a-f]{2}":
        type: array
        items:
          anyOf:
          - type: string
            format: ipv4
          - type: string
            format: ipv6
    additionalProperties: false
  labels:
    type: array
    items:
      type: string
required: [cluster, disk-encryption, hostname]
additionalProperties: false
definitions:
  ipv4-cidr:
    type: string
    pattern: "^[0-9.]+/[0-9]+$"
  ipv6-cidr:
    type: string
    pattern: "^[0-9a-f:]+/[0-9]+$"
