#!/usr/bin/env bash
set -Eeo pipefail; shopt -s inherit_errexit
[[ $1 != prereqs ]] || { echo "create-node-state"; exit 0; }

PKGROOT=$(realpath "$(dirname "$(realpath "${BASH_SOURCE[0]}")")/..")
# shellcheck source=../common.sh
source "$PKGROOT/common.sh"
# shellcheck source=../disk.sh
source "$PKGROOT/disk.sh"

main() {
  local devpath
  if devpath=$(get_node_config disk.devname); then
    if lsblk -Jndo PTUUID,NAME "$devpath" | jq -re --arg disk_uuid $DISK_UUID '.blockdevices[0].ptuuid==$disk_uuid' >/dev/null; then
      info "Mounting boot partition of disk at $devpath"
      boot_devpath=$(get_boot_devpath "$devpath")
      boot_path=/run/initramfs/boot
      mkdir $boot_path
      if mount -rt vfat "$boot_devpath" $boot_path; then
        error "Failed to mount boot partition"
      fi
    fi
  else
    warning "No disk detected"
  fi
}

main "$@"
