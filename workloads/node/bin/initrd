#!/usr/bin/env bash
# shellcheck source-path=../../..
set -Eeo pipefail; shopt -s inherit_errexit
PKGROOT=$(realpath "$(dirname "$(realpath "${BASH_SOURCE[0]}")")/../../..")

rm -rf "$PKGROOT/mnt/initrd"
mkdir "$PKGROOT/mnt/initrd"
objcopy -O binary -j.initrd "$PKGROOT/images/amd64/uki.efi" "$PKGROOT/mnt/initrd.cpio.zst"
cd "$PKGROOT/mnt/initrd"
zstd -cd "$PKGROOT/mnt/initrd" "$PKGROOT/mnt/initrd.cpio.zst" | cpio -idv


# (cd mnt/initrd; find . -print0 | cpio -ov --null --format=newc 2>/dev/null | zstd -19 > initrd.zst)
