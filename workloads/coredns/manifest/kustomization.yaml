apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: kube-system
resources:
- ../../settings
- coredns.yaml
- Kptfile
- resourcegroup.yaml
replacements:
- source: {fieldPath: data.cluster.coredns.svc.fixedIPv4, kind: ConfigMap, name: settings}
  targets:
  - select: {kind: Service, name: kube-dns}
    fieldPaths: [spec.clusterIP]
- source: {fieldPath: data.cluster.coredns.svc.fixedIPv4, kind: ConfigMap, name: settings}
  targets:
  - select: {kind: Service, name: kube-dns}
    fieldPaths: [spec.clusterIPs.0]
- source: {fieldPath: data.cluster.coredns.svc.fixedIPv6, kind: ConfigMap, name: settings}
  targets:
  - select: {kind: Service, name: kube-dns}
    fieldPaths: [spec.clusterIPs.1]
- source: {fieldPath: data.cluster.coredns.lb.fixedIPv4, kind: ConfigMap, name: settings}
  targets:
  - select: {kind: Service, name: external-dns}
    fieldPaths: [metadata.annotations.io\.cilium/lb-ipam-ips]
    options: {delimiter: ',', index: 0}
- source: {fieldPath: data.cluster.coredns.lb.fixedIPv6, kind: ConfigMap, name: settings}
  targets:
  - select: {kind: Service, name: external-dns}
    fieldPaths: [metadata.annotations.io\.cilium/lb-ipam-ips]
    options: {delimiter: ',', index: 1}
- source: {fieldPath: data.cluster.domain, kind: ConfigMap, name: settings}
  targets:
  - select: {kind: Service, name: external-dns}
    fieldPaths: [metadata.annotations.external-dns\.alpha\.kubernetes\.io/hostname]
    options: {delimiter: '.', index: 1}
  - select: {group: apps, kind: Deployment, name: coredns}
    fieldPaths: ["spec.template.spec.containers.[name=coredns].env.[name=DOMAIN].value"]
- source: {fieldPath: data.cluster.wanIPv4, kind: ConfigMap, name: settings}
  targets:
  - select: {group: apps, kind: Deployment, name: coredns}
    fieldPaths: ["spec.template.spec.containers.[name=coredns].env.[name=WAN_IPV4].value"]
- source: {fieldPath: data.machines.k8sMaster.fixedIPv4, kind: ConfigMap, name: settings}
  targets:
  - select: {group: apps, kind: Deployment, name: coredns}
    fieldPaths: ["spec.template.spec.containers.[name=coredns].env.[name=K8SMASTER_IPV4].value"]
- source: {fieldPath: data.machines.k8sMaster.fixedIPv6, kind: ConfigMap, name: settings}
  targets:
  - select: {group: apps, kind: Deployment, name: coredns}
    fieldPaths: ["spec.template.spec.containers.[name=coredns].env.[name=K8SMASTER_IPV6].value"]
- source: {fieldPath: data.cluster.etcd.fixedIPv4, kind: ConfigMap, name: settings}
  targets:
  - select: {group: apps, kind: Deployment, name: coredns}
    fieldPaths: ["spec.template.spec.containers.[name=coredns].env.[name=ETCD_IPV4].value"]
- source: {fieldPath: data.cluster.etcd.fixedIPv6, kind: ConfigMap, name: settings}
  targets:
  - select: {group: apps, kind: Deployment, name: coredns}
    fieldPaths: ["spec.template.spec.containers.[name=coredns].env.[name=ETCD_IPV6].value"]
- source: {fieldPath: data.nfsShares.homeCluster.addr, kind: ConfigMap, name: settings}
  targets:
  - select: {group: apps, kind: Deployment, name: coredns}
    fieldPaths: ["spec.template.spec.volumes.[name=config].nfs.server"]
- source: {fieldPath: data.nfsShares.homeCluster.path, kind: ConfigMap, name: settings}
  targets:
  - select: {group: apps, kind: Deployment, name: coredns}
    fieldPaths: ["spec.template.spec.volumes.[name=config].nfs.path"]
    options: {delimiter: /, index: 0}
