#!/usr/bin/env bash
# shellcheck source-path=..
set -Eeo pipefail; shopt -s inherit_errexit
PKGROOT=$(realpath "$(dirname "$(realpath "${BASH_SOURCE[0]}")")/..")

main() {
  STEPPATH=${STEPPATH:-$(step path --base)}
  local boot_server_ip admin_privkey
  boot_server_ip=$("$PKGROOT/workloads/node/bootstrap/assets/usr/local/bin/find-boot-server")
  admin_privkey=$STEPPATH/system:admin.key
  python3 -m venv "$PKGROOT/.venv"
  "$PKGROOT/.venv/bin/pip3" install -qr "$PKGROOT/workloads/node/containers/boot-server/requirements.txt"
  PYTHONPATH=$PKGROOT/workloads/node/scripts \
    exec "$PKGROOT/.venv/bin/python3" \
      -m boot-server.configure \
      --boot-server-ip "$boot_server_ip" \
      --admin-privkey "$admin_privkey" \
      --cafile "$PKGROOT/.step/certs/root_ca.crt" \
      "$@"
}

main "$@"
