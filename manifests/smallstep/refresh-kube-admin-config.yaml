---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: refresh-kube-admin-config
  labels:
    app.kubernetes.io/name: smallstep
    app.kubernetes.io/component: refresh-kube-admin-config
spec:
  schedule: "00 05 * * *"
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: smallstep
            app.kubernetes.io/component: refresh-kube-admin-config
        spec:
          nodeSelector:
            kubernetes.io/hostname: machines.k8sMaster.hostname
          restartPolicy: Never
          containers:
          - name: refresh-kube-admin-config
            image: cr.step.sm/smallstep/step-ca-bootstrap:latest
            command: [/home/step/create-kube-admin-config.sh]
            securityContext:
              readOnlyRootFilesystem: true
            env:
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: K8S_API_HOST
              value: machines.k8sMaster.hostname
            - name: KUBE_CONFIG_OWNER
              value: admin.uid
            volumeMounts:
            - name: bootstrap
              mountPath: /home/step/create-kube-admin-config.sh
              subPath: create-kube-admin-config.sh
              readOnly: true
            - name: kube-apiserver-client-ca-cert
              mountPath: /home/step/certs/kube_apiserver_client_ca.crt
              readOnly: true
            - name: kube-apiserver-client-ca-key
              mountPath: /home/step/certs/kube_apiserver_client_ca_key
              readOnly: true
            - name: certs
              mountPath: /home/step/certs
              readOnly: false
            - name: persistent-certs
              mountPath: /home/step/persistent-certs
              readOnly: false
          volumes:
          - name: bootstrap
            configMap:
              name: bootstrap
              defaultMode: 0777
          - name: kube-apiserver-client-ca-cert
            hostPath:
              path: /var/lib/persistent/lib-rancher/k3s/server/tls/client-ca.crt
              type: File
          - name: kube-apiserver-client-ca-key
            hostPath:
              path: /var/lib/persistent/lib-rancher/k3s/server/tls/client-ca.key
              type: File
          - name: certs
            emptyDir:
              medium: Memory
          - name: persistent-certs
            persistentVolumeClaim:
              claimName: step-ca-certs
